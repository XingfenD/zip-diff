# Stage1-Week3

## Target

通读方法与实验部分，整理技术路线（差异检测→样本生成→多解析器对比）

### Detailed

- 学习理解ZIPDIFF的工作流程；

### Deliverables

详细的技术路线图 + 文字解释 + 讲解

## Content

### 工作流程概览

```mermaid
sequenceDiagram
    participant 初始化模块
    participant 测试用例生成器
    participant UCB策略选择器
    participant 变异引擎
    participant 多解析器测试执行器
    participant 差异分析器
    participant 结果存储
    participant 50个ZIP解析器

    %% 初始化阶段
    初始化模块->>初始化模块: 收集19种语言的50个ZIP解析器
    初始化模块->>初始化模块: 创建Docker隔离环境
    初始化模块->>UCB策略选择器: 初始化46种变异策略权重
    初始化模块->>结果存储: 初始化语料库和统计信息

    %% 初始测试用例生成
    初始化模块->>测试用例生成器: 请求生成初始测试用例
    测试用例生成器->>测试用例生成器: 生成1000个基础ZIP文件
    测试用例生成器->>结果存储: 存储初始测试用例集

    loop 迭代优化 (最多10000次)
        %% 选择种子样本
        结果存储->>结果存储: 选择种子样本

        %% UCB策略选择
        结果存储->>UCB策略选择器: 获取当前样本
        UCB策略选择器->>UCB策略选择器: 计算各策略UCB权重
        UCB策略选择器->>UCB策略选择器: 应用softmax选择策略
        UCB策略选择器->>变异引擎: 返回选择的变异策略

        %% 应用变异
        结果存储->>变异引擎: 提供种子样本
        变异引擎->>变异引擎: 应用ZIP级别变异
        变异引擎->>变异引擎: 应用字节级别变异
        变异引擎->>多解析器测试执行器: 输出变异后的测试用例

        %% 多解析器并行测试
        多解析器测试执行器->>50个ZIP解析器: 并行执行测试
        50个ZIP解析器->>多解析器测试执行器: 返回解析结果
        多解析器测试执行器->>差异分析器: 传递所有解析结果

        %% 差异分析
        差异分析器->>差异分析器: 计算输出目录哈希
        差异分析器->>差异分析器: 比较解析结果
        差异分析器->>差异分析器: 识别不一致解析器对
        差异分析器->>结果存储: 存储分析结果

        %% 更新UCB参数
        差异分析器->>UCB策略选择器: 反馈变异效果
        UCB策略选择器->>UCB策略选择器: 更新策略权重
        UCB策略选择器->>UCB策略选择器: 应用权重衰减机制

        %% 更新语料库
        alt 发现新的不一致性
            差异分析器->>结果存储: 添加到语料库
            结果存储->>结果存储: 更新统计信息
        end

        %% 定期报告
        alt 每1000次迭代
            结果存储->>结果存储: 生成状态报告
        end
    end

    %% 最终结果
    结果存储->>结果存储: 生成最终报告
    结果存储->>结果存储: 整理14种解析歧义类型
    结果存储->>结果存储: 统计1221/1225不一致解析器对
```

### 工作流程详细解释

#### 测试用例生成器

```mermaid
graph TD
    subgraph 初始化阶段
        A["开始初始化"] --> A1["构建基础样本"]
        A1 --> A1a["创建包含标准结构的ZIP<br/>- 文件: 'a' (内容'a')<br/>- 目录文件: 'b/c' (内容'c')、'b/d' (内容'd')<br/>- 完成ZIP归档(finalize)"]

        A --> A2["生成随机样本集<br/>(数量=配置的batch_size)"]
        A2 --> A2a["随机化文件数量<br/>(0-5个文件)"]
        A2 --> A2b["随机生成文件名<br/>(长度0-5字节，随机字符串)"]
        A2 --> A2c["随机生成文件内容<br/>(长度0-10字节，随机字节)"]
        A2 --> A2d["随机选择压缩算法<br/>- 80%概率: STORED/DEFLATED<br/>- 20%概率: BZIP2/ZSTD/LZMA/XZ"]
        A2 --> A2e["随机添加EOCD记录<br/>(20%概率添加ZIP结束标记)"]
        A2a & A2b & A2c & A2d & A2e --> A2f["组装并完成ZIP归档"]

        A1a & A2f --> A3["初始语料库生成完成"]
    end

    subgraph 变异生成阶段
        B["从语料库选择种子样本"] --> C["随机决定变异次数<br/>(1-32次，概率2^-x)"]
        C --> D{"应用变异操作"}

        D -->|"结构级变异"| E["ZIP结构修改"]
        E --> E1["文件条目操作<br/>- AddFileEntry(添加文件)<br/>- RemoveLfh/RemoveCdh(删除头信息)"]
        E --> E2["字段修改<br/>- ModifyCrc32(校验值)<br/>- ModifyCompressionMethod(压缩方式)"]

        D -->|"字节级变异"| F["原始字节修改"]
        F --> F1["基础修改<br/>- ModifyByte(修改字节)<br/>- FlipBit(翻转比特)"]
        F --> F2["片段操作<br/>- InsertBytes(插入)<br/>- DeleteBytes(删除)"]

        E & F --> G["生成新测试用例"]
    end

    subgraph 管理与输出
        G --> H["去重检查<br/>(通过blake3哈希校验)"]
        H --> I{"已存在?"}
        I -->|"是"| J["丢弃重复样本"]
        I -->|"否"| K["添加到语料库"]
        K --> L["结合手动构造用例<br/>(如路径歧义测试: '/a/b'与'a\\b')"]
        L --> M["输出完整测试用例集"]
    end

    A3 --> B
    K --> B
```

#### UCB策略选择器

```mermaid
graph TD
    A[UCB算法策略选择开始] --> B[初始化策略统计数据]
    B --> C{是否为首次选择?}
    C -- 是 --> D[初始化所有策略权重为1.0]
    C -- 否 --> E[加载历史统计数据]

    E --> F[计算每个策略的UCB值]
    F --> G[获取策略使用次数]
    F --> H[获取策略累积奖励]
    F --> I[计算总试验次数]

    G & H & I --> J[计算策略平均奖励]
    J --> K[计算探索项 - 基于总试验次数和策略使用次数]
    K --> L[UCB值 = 平均奖励 + 探索项]

    L --> M[应用softmax函数]
    M --> N[计算温度参数]
    N --> O[计算每个策略的选择概率]

    O --> P[基于概率分布随机选择策略]
    P --> Q[执行选定的突变策略]
    Q --> R[收集执行结果]

    R --> S{是否发现新的不一致性?}
    S -- 是 --> T[给予正奖励]
    S -- 否 --> U[给予负奖励]

    T & U --> V[更新策略统计数据]
    V --> W[增加策略使用次数]
    V --> X[更新累积奖励]
    V --> Y[应用历史衰减]

    Y --> Z[保存更新后的统计数据]
    Z --> AA[返回选定的策略]

    class A startNode;
    class B,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,V,W,X,Y,Z processNode;
    class C,S decisionNode;
    class AA endNode;
```

#### 变异策略

```mermaid
graph TD
    A[变异引擎开始] --> B[接收输入样本]
    B --> C[解析输入为ZIP结构]
    C --> D{是否为结构化ZIP文件?}
    D -- 否 --> E[直接进行字节级变异]
    D -- 是 --> F[分析ZIP文件结构]

    F --> G[提取ZIP元数据]
    G --> H[识别可变异字段]
    H --> I[获取UCB策略选择结果]

    I --> J{选择变异类型}
    J -- ZIP级别变异 --> K[执行ZIP结构变异]
    J -- 字节级别变异 --> L[执行字节序列变异]

    K --> M[选择目标字段]
    M --> N{字段类型}
    N -- 压缩方法 --> O[随机选择有效压缩算法]
    N -- 文件时间戳 --> P[随机修改时间戳值]
    N -- CRC校验值 --> Q[生成随机CRC值]
    N -- 文件大小 --> R[调整大小字段]
    N -- 文件名 --> S[修改文件名或路径]
    N -- 额外字段 --> T[添加/修改/删除额外字段]
    N -- 标志位 --> U[翻转特定标志位]

    O & P & Q & R & S & T & U --> V[更新依赖字段]
    V --> W[重新计算校验和]
    W --> X[重建ZIP结构]

    L --> Y{选择字节变异操作}
    Y -- 插入 --> Z[随机位置插入字节]
    Y -- 删除 --> AA[随机位置删除字节]
    Y -- 修改 --> BB[随机修改字节值]
    Y -- 复制 --> CC[复制字节块到新位置]
    Y -- 拼接 --> DD[拼接其他文件片段]
    Y -- 位翻转 --> EE[随机翻转比特位]

    Z & AA & BB & CC & DD & EE --> FF[生成变异后的字节序列]

    X & FF --> GG{是否需要多次变异?}
    GG -- 是 --> HH[应用更多变异策略]
    GG -- 否 --> II[生成最终变异样本]

    II --> JJ[保存变异记录]
    JJ --> KK[输出变异后的测试用例]

    class A start;
    class B,C,E,F,G,H,I,K,L,M,O,P,Q,R,S,T,U,V,W,X,Y,Z,AA,BB,CC,DD,EE,FF,HH,II,JJ process;
    class D,J,N,Y,GG decision;
    class KK finish;
```

##### Zip级变异

| 变异类别           | 具体变异方式       | 描述                             | 变异目标                             |
| ------------------ | ------------------ | -------------------------------- | ------------------------------------ |
| **压缩方法变异**   | 随机选择压缩算法   | 在有效的压缩算法中随机选择       | 本地文件头和中央目录头的压缩方法字段 |
|                    | 强制使用存储模式   | 将压缩方法设置为0（无压缩）      | 压缩方法字段                         |
|                    | 无效压缩方法测试   | 设置无效的压缩方法值             | 压缩方法字段                         |
| **时间戳变异**     | 随机修改时间戳     | 随机生成创建、修改、访问时间     | 各种时间戳字段                       |
|                    | 时间戳溢出测试     | 设置超出正常范围的时间值         | 时间戳字段                           |
|                    | 时间戳归零         | 将时间戳设置为0                  | 时间戳字段                           |
| **CRC校验变异**    | 随机CRC值          | 生成随机的CRC32校验值            | CRC校验字段                          |
|                    | CRC与数据不匹配    | 修改数据但保持原有CRC            | 数据字段或CRC字段                    |
| **文件大小变异**   | 随机调整大小值     | 修改文件大小字段但保持数据不变   | 压缩和未压缩大小字段                 |
|                    | 大小字段不匹配     | 使压缩大小大于未压缩大小         | 大小字段                             |
|                    | 超大文件大小       | 设置异常大的文件大小值           | 大小字段                             |
| **文件名变异**     | 随机字符替换       | 随机替换文件名中的字符           | 文件名字段                           |
|                    | 路径遍历序列       | 插入../等路径遍历字符            | 文件名字段                           |
|                    | 空文件名           | 将文件名设置为空字符串           | 文件名字段                           |
|                    | 超长文件名         | 创建超过255字符的文件名          | 文件名字段                           |
|                    | 特殊字符测试       | 插入Unicode或控制字符            | 文件名字段                           |
| **额外字段变异**   | 添加随机额外字段   | 插入随机的额外字段数据           | 额外字段区域                         |
|                    | 修改现有额外字段   | 改变已有的额外字段内容           | 额外字段                             |
|                    | 超大额外字段       | 创建异常大的额外字段             | 额外字段                             |
| **标志位变异**     | 随机翻转标志位     | 随机改变标志位的值               | 通用标志位字段                       |
|                    | 强制设置保留位     | 设置保留的标志位                 | 标志位字段                           |
|                    | 启用所有标志       | 设置所有可能的标志位             | 标志位字段                           |
| **中央目录变异**   | 目录与文件头不匹配 | 使中央目录与本地文件头信息不一致 | 中央目录条目                         |
|                    | 重复中央目录       | 创建重复的中央目录条目           | 中央目录                             |
|                    | 缺失中央目录       | 删除部分或全部中央目录           | 中央目录                             |
| **数据描述符变异** | 添加数据描述符     | 为没有描述符的文件添加描述符     | 数据描述符字段                       |
|                    | 修改数据描述符     | 改变现有数据描述符的内容         | 数据描述符                           |
| **跨字段依赖变异** | 破坏字段间一致性   | 修改一个字段但不更新相关字段     | 相互依赖的字段组                     |
|                    | 链式变异           | 同时修改多个相关字段             | 多个相关字段                         |

##### 字节级变异

| 变异类别         | 具体变异方式   | 描述                         | 变异目标       |
| ---------------- | -------------- | ---------------------------- | -------------- |
| **基本字节操作** | 随机字节修改   | 随机选择位置修改字节值       | 文件的任意位置 |
|                  | 字节插入       | 在随机位置插入一个或多个字节 | 文件的任意位置 |
|                  | 字节删除       | 从随机位置删除一个或多个字节 | 文件的任意位置 |
|                  | 字节复制       | 复制一段字节到另一个位置     | 文件的任意位置 |
|                  | 字节交换       | 交换文件中的两个字节块       | 文件的任意位置 |
| **位级操作**     | 随机位翻转     | 随机选择一个比特位并翻转     | 文件的任意位置 |
|                  | 连续位翻转     | 翻转连续的多个比特位         | 文件的任意位置 |
| **块操作**       | 块重复         | 将文件的一部分重复多次       | 文件的任意块   |
|                  | 块清零         | 将文件的一部分设置为0        | 文件的任意块   |
|                  | 块随机化       | 将文件的一部分替换为随机数据 | 文件的任意块   |
| **文件级操作**   | 文件截断       | 将文件截断到随机长度         | 文件末尾       |
|                  | 文件扩展       | 在文件末尾添加随机数据       | 文件末尾       |
|                  | 头部修改       | 修改文件的前N个字节          | 文件头部       |
|                  | 尾部修改       | 修改文件的后N个字节          | 文件尾部       |
| **特殊模式**     | 模式插入       | 插入特定的字节模式           | 文件的任意位置 |
|                  | 压缩数据变异   | 直接修改压缩数据             | 压缩数据区域   |
|                  | 元数据区域变异 | 专门针对元数据区域进行变异   | 文件元数据区域 |

#### 差异分析器

```mermaid
graph TD
    A[差异分析开始] --> B[执行多解析器测试]
    B --> C[收集所有解析器的输出结果]

    C --> D[预处理结果]
    D --> E[过滤无效字符文件名]
    E --> F[忽略空目录]
    F --> G[标准化文件系统元数据]

    G --> H[计算输出目录哈希]
    H --> I[构建解析器结果矩阵]

    I --> J[比较解析器对结果]
    J --> K{结果是否一致?}
    K -- 一致 --> L[记录一致性]
    K -- 不一致 --> M[初步筛选有意义差异]

    M --> N{差异类型判断}
    N -- 文件名无效字符差异 --> O[标记为无意义差异]
    N -- 路径处理差异 --> P[标记为有意义差异]
    N -- 文件内容差异 --> Q[标记为有意义差异]
    N -- 元数据处理差异 --> R[标记为有意义差异]
    N -- 结构解析差异 --> S[标记为有意义差异]

    O --> T[过滤无意义差异]
    P & Q & R & S --> U[分类有意义差异]

    U --> V[分析差异影响范围]
    V --> W{是否为新发现的差异?}
    W -- 是 --> X[添加到新发现集合]
    W -- 否 --> Y[更新现有统计]

    L & T & X & Y --> Z[生成差异分析报告]
    Z --> AA[输出关键发现]
    AA --> AB[差异分析完成]

    class A start;
    class B,C,D,E,F,G,H,I,J,L,M,O,T,U,V,X,Y,Z,AA process;
    class K,N,W decision;
    class P,Q,R,S meaningful;
    class AB finish;
```

## Questions
